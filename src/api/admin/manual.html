<!DOCTYPE html>

<head>
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width,initial-scale=1">
	<title>Program documentation</title>
</head>

<!--

	TODO: Fix error rate limiting (return 0 tokens for an error)

-->

<!--
	Yes, this HTML is hand-written.
	Any commented-out behavior (such as configuration options for features) should be considered undocumented, as most of it is either broken and/or *very* incomplete.

	Use undocumented features at your own risk. They may lead to dangerous and unexpected behavior, such as database corruption, program crashes, leakage of sensitive information, or other damaging results. Please, don't use them in production if you value your job.

	Undocumented features that don't require administrative permissions to enable will not lead to dangerous behavior. However, they may still lead to unexpected results, which may contradict their incomplete documentation.
-->

<body>
	<h1>Generative Model Proxy Server</h1>
	<nav id="table-of-contents">
		<h2>Table of Contents</h2>
		<ol>
			<li><a href="#overview">Request Routing Overview</a></li>
			<li><a href="#objects">Internal Objects</a>
				<ol>
					<li><a href="#user">User</a></li>
					<li><a href="#role">Role</a></li>
					<li><a href="#model">Model</a></li>
					<li><a href="#quota">Quota</a></li>
					<li><a href="#datatypes">Datatypes</a>
						<ol>
							<li><a href="#positive-whole-number">PositiveWholeNumber</a></li>
							<li><a href="#uuid">Uuid</a></li>
						</ol>
					</li>
				</ol>
			</li>
			<li><a href="#api-examples">API Examples</a>
				<ol>
					<li><a href="#admin-api-examples">Admin API</a></li>
					<li>Model API</li>
				</ol>
			</li>
			<li>Model Request Routing</li>
			<li>Additional Configuration</li>
		</ol>
	</nav>
	<section id="overview">
		<h2>Request Routing Overview</h2>
		<p>Requests are routed to the following endpoints, in order of priority:</p>
		<ul>
			<li>/admin/ - <code>admin_router</code> endpoints
				<ul>
					<li>/{<a href="./users">users</a>|<a href="./roles">roles</a>|<a href="./models">models</a>|<a
							href="./quotas">quotas</a>}
						<ul>
							<li>GET /</li>
							<li>POST / - JSON body required. Cannot be used to create an object with a specific UUID.
							</li>
							<li>PUT / - JSON body required. Object must contain a valid UUID.</li>
							<li>GET /:uuid</li>
							<li>PUT /:uuid - JSON body required. Cannot be used to change the object's UUID.</li>
							<li>DELETE /:uuid</li>
						</ul>
					</li>
					<li>GET <a href="./help">/help</a>
						<ul>
							<li>If the database has at least one user, the embedded <code>manual.html</code> page (this
								page) will be returned.</li>
							<li>If the database does not contain any users, the embedded
								<code>setup-instructions.html</code> page will be returned.
							</li>
						</ul>
					</li>
				</ul>
			</li>
			<li>/ - <code>model_request</code> endpoints (see <a href="#model">Model</a> object for available
				endpoints)
				<ul>
					<li>GET {endpoint}</li>
					<li>POST {endpoint} - JSON body<!-- or HTML Form data--> required</li>
				</ul>
			</li>
		</ul>
	</section>
	<section id="objects">
		<h2>Internal Objects</h2>
		<p>Object fields are mandatory unless otherwise specified.</p>
		<p>The following types of objects can be modified using the /admin/ API:</p>
		<ul>
			<li id="user">User
				<ul>
					<li>(optional) label: String
						<ul>
							<li>A human-readable label for the object. Multiple objects may have the same label.</li>
						</ul>
					</li>
					<li>(optional*) uuid: Uuid
						<ul>
							<li>Used as a reference to the object in logs, API calls, and from other objects (if
								applicable).</li>
							<li>A cryptographically hashed copy of the user's Uuid may be forwarded to model backends.
							</li>
						</ul>
					</li>
					<li>(optional) admin: Boolean
						<ul>
							<li>Allows giving administrative access to the user. This allows
								<strong>unrestricted
									access</strong> to the /admin/ API, but does not otherwise change how requests are
								handled.
							</li>
						</ul>
					</li>
					<li>(optional) api_keys: []String
						<ul>
							<li>A list of API keys that the user can authenticate with.</li>
							<li>The /admin/ API will not allow multiple users to have the same API key.</li>
						</ul>
					</li>
					<li>(optional) roles: []Uuid
						<ul>
							<li>A list of roles that the user should inherit models, quotas, and administrative status
								(if
								applicable) from.
							</li>
						</ul>
					</li>
					<li>(optional) models: []Uuid
						<ul>
							<li>A list of models that the user should be able to access.</li>
						</ul>
					</li>
					<li>(optional) quotas: []Uuid
						<ul>
							<li>A list of rate limiters that the user should be subject to.</li>
						</ul>
					</li>
				</ul>
			</li>
			<li id="role">Role
				<ul>
					<li>(optional) label: String
						<ul>
							<li>A human-readable label for the object. Multiple objects may have the same label.</li>
						</ul>
					</li>
					<li>(optional*) uuid: Uuid
						<ul>
							<li>Used as a reference to the object in logs, API calls, and from other objects (if
								applicable).</li>
						</ul>
					</li>
					<li>(optional) admin: Boolean
						<ul>
							<li>Allows giving administrative access to all users with this role. This allows
								<strong>unrestricted
									access</strong> to the /admin/ API, but does not otherwise change how requests are
								handled.
							</li>
						</ul>
					</li>
					<li>(optional) models: []Uuid
						<ul>
							<li>A list of models that all users with this role should be able to access.</li>
						</ul>
					</li>
					<li>(optional) quotas: []Uuid
						<ul>
							<li>A list of rate limiters that all users with this role should be subject to.</li>
						</ul>
					</li>
				</ul>
			</li>
			<li id="model">Model
				<ul>
					<li>(optional) label: String
						<ul>
							<li>A human-readable label for the object. Multiple objects may have the same label.</li>
						</ul>
					</li>
					<li>(optional*) uuid: Uuid
						<ul>
							<li>Used as a reference to the object in logs, API calls, and from other objects (if
								applicable).</li>
						</ul>
					</li>
					<li>(optional) name: String
						<ul>
							<li>Used to refer to the model in API calls.</li>
							<li>Model names should be carefully managed by the administrator. Having the same name +
								ModelType refer to multiple models that a user/role can access will lead to inconsistent
								behavior.</li>
						</ul>
					</li>
					<li>api: Object or String
						<ul>
							<li>(Key) String
								<ul>
									<li>The backend type used to handle requests to this model, represented as a String.
									</li>
								</ul>
							</li>
							<li>(Value) Object
								<ul>
									<li>An object containing backend-specific configuration options.</li>
									<li>If a backend has no configuration options, model.api should be represented
										by a String instead.</li>
								</ul>
							</li>
							<li>The following backends are currently supported:
								<ul>
									<li>OpenAI
										<ul>
											<li>model_string: String</li>
											<li>(optional) model_context_len: PositiveWholeNumber</li>
											<li>openai_api_base: String</li>
											<li>openai_api_key: String</li>
											<li>(optional) openai_organization: String</li>
										</ul>
									</li>
									<li>Loopback
										<ul>
											<li>This backend has no configuration options.</li>
										</ul>
									</li>
								</ul>
							</li>
							<li>Additional backends may be added in future releases.</li>
						</ul>
					</li>
					<li>(optional) types: []String
						<ul>
							<li>A list of endpoint types that this model should respond to requests from.</li>
							<li>The following types are currently supported:
								<ul>
									<li>TextChat
										<ul>
											<li>/v1/chat/completions (OpenAI)</li>
										</ul>
									</li>
									<li>TextCompletion
										<ul>
											<li>/v1/completions (OpenAI)</li>
										</ul>
									</li>
									<li>TextEdit
										<ul>
											<li>/v1/edits (OpenAI)</li>
										</ul>
									</li>
									<li>TextEmbedding
										<ul>
											<li>/v1/embeddings (OpenAI)</li>
										</ul>
									</li>
									<li>TextModeration
										<ul>
											<li>/v1/moderations (OpenAI)</li>
										</ul>
									</li>
									<!--
										The ImageGeneration ModelType could potentially work fine, it's just untested and kinda incomplete.
										However, the rest of these likely won't work.

									<li>ImageGeneration
										<ul>
											<li>/v1/images/generations (OpenAI)</li>
										</ul>
									</li>
									<li>ImageEdit
										<ul>
											<li>/v1/images/edits (OpenAI)</li>
										</ul>
									</li>
									<li>ImageVariation
										<ul>
											<li>/v1/images/variations (OpenAI)</li>
										</ul>
									</li>
									<li>AudioTTS
										<ul>
											<li>/v1/audio/speech (OpenAI)</li>
										</ul>
									</li>
									<li>AudioTranscription
										<ul>
											<li>/v1/audio/transcriptions (OpenAI)</li>
										</ul>
									</li>
									<li>AudioTranslation
										<ul>
											<li>/v1/audio/translations (OpenAI)</li>
										</ul>
									</li> -->
								</ul>
							</li>
							<li>Additional types may be added in future releases.</li>
						</ul>
					</li>
					<li>(optional) quotas: []Uuid
						<ul>
							<li>A list of rate limiters that all requests to this model should be subject to.</li>
							<li>Note: Some model backends may perform rate limiting independently of this option, using
								information like HTTP headers from the backend.</li>
						</ul>
					</li>
				</ul>
			</li>
			<li id="quota">Quota
				<ul>
					<li>(optional) label: String
						<ul>
							<li>A human-readable label for the object. Multiple objects may have the same label.</li>
						</ul>
					</li>
					<li>(optional*) uuid: Uuid
						<ul>
							<li>Used as a reference to the object in logs, API calls, and from other objects (if
								applicable).</li>
						</ul>
					</li>
					<li>(optional) limits: []Object
						<ul>
							<li>A list of rate limits that this rate limiter contains.</li>
							<li>count: PositiveWholeNumber
								<ul>
									<li>The maximum number of items per period.</li>
								</ul>
							</li>
							<li>type: String
								<ul>
									<li>The type of item that this limiter should limit.</li>
									<li>The following item types are supported:
										<ul>
											<li>Request</li>
											<li>Token</li>
										</ul>
									</li>
								</ul>
							</li>
							<li>period: PositiveWholeNumber
								<ul>
									<li>The period of time that this limit covers (ex. per-hour, per-minute, etc), in
										seconds.
									</li>
								</ul>
							</li>
							<li>(optional) state: Object
								<ul>
									<li>An object storing the state of a Limit.</li>
									<li>If not specified when updating an existing Limit (such as when updating a
										Quota), the
										state of
										the
										Limit will be reset.
										<ul>
											<li>This behavior may change in a future release.</li>
										</ul>
									</li>
									<li>This object's format may change between releases, and should not be relied upon.
									</li>
								</ul>
							</li>
						</ul>
					</li>
				</ul>
			</li>
			<li>* - UUIDs are mandatory when creating an object using the PUT method.</li>
		</ul>
		<section id="datatypes">
			<h3>Datatype JSON Representations</h3>
			<p>The following datatypes have non-trivial JSON representations:</p>
			<ul>
				<li id="positive-whole-number">PositiveWholeNumber (number)
					<ul>
						<li>A whole number greater than or equal to zero.</li>
						<li>Cannot be greater than (2^64)-1.</li>
					</ul>
				</li>
				<li id="uuid">Uuid (String)
					<ul>
						<li>A unique RFC4122-compliant UUID, represented in hyphenated form as a lowercase String.
						</li>
						<li>An example of a Uuid is <code>"67e55044-10b1-426f-9247-bb680e5fe0c8"</code>.</li>
						<li>A Uuid of all zeros is referred to as the null Uuid. Objects with a null Uuid cannot be
							created,
							retrieved, modified, or deleted via the /admin/ API.
						</li>
					</ul>
				</li>
			</ul>
		</section>
	</section>
	<section id="api-examples">
		<h2>API Examples</h2>
		<p>The following examples will use the CLI tools <a href="https://curl.se"><code>curl</code></a> and <a
				href="https://jqlang.github.io/jq/"><code>jq</code></a> to allow them to be easily executable. However,
			other tools with similar functionality can be used instead.
		</p>
		<section id="admin-api-examples">
			<h3>Admin API Examples</h3>
			<div id="admin-api-key-section"></div>
			<h4>Basic Object Modification</h4>
			<p>There are multiple ways to add an object, such as a User. One way to do so is through a POST request.</p>
			<pre>
<code class="curl-users">curl -v "http://localhost:8080/admin/users" \</code>
<code class="admin-authorization">	--oauth2-bearer "YOUR_API_KEY_GOES_HERE" \</code>
<code>	--json \</code>
<code>'{</code>
<code>	"label": "Alice",</code>
<code>	"api_keys": [</code>
<code id="example-key-0-json">		"ALICE_S_API_KEY_GOES_HERE"</code>
<code>	],</code>
<code>	"admin": true</code>
<code>}'</code></pre>
			<p>This should look familiar, as it's similar to the command from the first-time setup. This adds an
				administrator user
				named
				Alice, with an API key of <span id="example-key-0-text">ALICE_S_API_KEY_GOES_HERE</span>. The request
				will
				return the Uuid of the added
				object, allowing additional actions to be easily performed on it.</p>
			<p>However, this is not the only way to add objects. Objects can also be added through PUT requests as well.
			</p>
			<pre>
<code class="curl-users">curl -v "http://localhost:8080/admin/users" \</code>
<code class="admin-authorization">	--oauth2-bearer "YOUR_API_KEY_GOES_HERE" \</code>
<code>	--request PUT \</code>
<code>	--json \</code>
<code>'{</code>
<code>	"label": "Bob",</code>
<code>	"uuid": "a6d10077-362b-4cb8-843d-0a38b7c0b07d"</code>
<code>}'</code></pre>
			<p>This adds a user named Bob. Unlike Alice, who has a Uuid
				generated by the server, Bob will have a Uuid of
				a6d10077-362b-4cb8-843d-0a38b7c0b07d.</p>
			<p>Let's list all the user objects in our database, to make sure these API calls executed properly.</p>
			<pre>
<code class="curl-users">curl -v "http://localhost:8080/admin/users" \</code>
<code class="admin-authorization">	--oauth2-bearer "YOUR_API_KEY_GOES_HERE" \</code>
<code>	| jq .</code></pre>
			<p>It's also possible to only retrieve a specific object, which can be useful for large databases. Let's
				retrieve Bob using the Uuid mentioned earlier.</p>
			<pre>
<code class="curl-user-bob">curl -v "http://localhost:8080/admin/users/a6d10077-362b-4cb8-843d-0a38b7c0b07d" \</code>
<code class="admin-authorization">	--oauth2-bearer "YOUR_API_KEY_GOES_HERE" \</code>
<code>	| jq .</code></pre>
			<p>Since we didn't give Bob an API key when adding him, let's give him one now.</p>
			<pre>
<code class="curl-user-bob">curl -v "http://localhost:8080/admin/users/a6d10077-362b-4cb8-843d-0a38b7c0b07d" \</code>
<code class="admin-authorization">	--oauth2-bearer "YOUR_API_KEY_GOES_HERE" \</code>
<code>	--request PUT \</code>
<code>	--json \</code>
<code>'{</code>
<code>	"label": "Bob",</code>
<code>	"api_keys": [</code>
<code id="example-key-1">		"BOB_S_API_KEY_GOES_HERE"</code>
<code>	]</code>
<code>}'</code></pre>
			<p>Unlike adding a user, modifying an object using a PUT request does not require the Uuid to be specified
				in the object, as it's already specified in the URL.</p>
			<p>However, keep in mind that this is replacing the object, rather than simply adding fields to it. If a
				field is ommitted when updating an object, that field will be removed.</p>
			<p>Now, let's try deleting Bob from the database.</p>
			<pre>
<code class="curl-user-bob">curl -v "http://localhost:8080/admin/users/a6d10077-362b-4cb8-843d-0a38b7c0b07d" \</code>
<code class="admin-authorization">	--oauth2-bearer "YOUR_API_KEY_GOES_HERE" \</code>
<code>	--request DELETE</code></pre>
			<h4>Managing Larger Userbases</h4>
			<p>As the number of users using the proxy grows, it becomes tedious to manage them all individually. As a
				result, the Role object exists to apply certain properties to groups of users.</p>
			<p>Let's create a few users to manage: June, July, Angel, Dolly, and Hazel.</p>

			<h4>Adding Models</h4>
			<h4>Rate Limiting</h4>
		</section>
		<section id="model-api-examples">
			<h3>Model API Examples</h3>
		</section>
	</section>
	<section id="model-request-routing">
		<h2>Model Request Routing</h2>
	</section>
	<section id="additional-configuration">
		<h2>Additional Configuration</h2>
	</section>
	<footer>
		<hr />
		<p><a href="https://github.com/transkatgirl/generative-model-proxy-server">Generative Model Proxy Server</a> by
			<a href="https://github.com/transkatgirl">transkatgirl</a>
		</p>
	</footer>
	<script>
		// I barely ever write JavaScript. Please look the other way!
		// :)

		function get_curl_url(relative) {
			let url = JSON.stringify(new URL(relative, new URL(window.location.pathname, window.location.origin).href));
			return `curl -v ${url} \\`;
		}

		function get_curl_oauth(api_key) {
			let json_key;
			if (api_key) {
				json_key = JSON.stringify(api_key);
			} else {
				json_key = "\"YOUR_API_KEY_GOES_HERE\"";
			};
			return `	--oauth2-bearer ${json_key}`;
		}

		const cyrb53 = (str, seed = 0) => {
			let h1 = 0xdeadbeef ^ seed, h2 = 0x41c6ce57 ^ seed;
			for (let i = 0, ch; i < str.length; i++) {
				ch = str.charCodeAt(i);
				h1 = Math.imul(h1 ^ ch, 2654435761);
				h2 = Math.imul(h2 ^ ch, 1597334677);
			}
			h1 = Math.imul(h1 ^ (h1 >>> 16), 2246822507);
			h1 ^= Math.imul(h2 ^ (h2 >>> 13), 3266489909);
			h2 = Math.imul(h2 ^ (h2 >>> 16), 2246822507);
			h2 ^= Math.imul(h1 ^ (h1 >>> 13), 3266489909);

			return 4294967296 * (2097151 & h2) + (h1 >>> 0);
		};

		function dec2base32(dec) {
			return dec.toString(32).padStart(2, "0");
		}

		function generate_random_key(len) {
			var arr = new Uint8Array((len || 40) / 2);
			window.crypto.getRandomValues(arr);
			return Array.from(arr, dec2base32).join('');
		}

		function get_example_api_key(base, seed, is_json) {
			if (is_json) {
				let json_key = JSON.stringify(cyrb53(base, seed).toString(32) + cyrb53(base, seed + 1).toString(32));
				return `		${json_key}`;
			} else {
				return cyrb53(base, seed).toString(32) + cyrb53(base, seed + 1).toString(32);
			}
		}

		function update_example_api_keys(base) {
			document.getElementById("example-key-0-json").innerText = get_example_api_key(base, 0, true);
			document.getElementById("example-key-0-text").innerText = get_example_api_key(base, 0, false);
			document.getElementById("example-key-1").innerText = get_example_api_key(base, 1, true);
		}

		document.getElementById("admin-api-key-section").innerHTML = '<label for="admin-api-key-input">Admin API Key:</label> <input type="text" placeholder="YOUR_API_KEY_GOES_HERE" id="admin-api-key-input" required />';

		document.getElementById("admin-api-key-input").addEventListener("change", (event) => {
			let authorization = document.getElementsByClassName("admin-authorization");
			for (let i = 0; i < authorization.length; i++) {
				authorization[i].textContent = get_curl_oauth(event.target.value) + " \\";
			}

			if (event.target.value) {
				update_example_api_keys(event.target.value);
			} else {
				update_example_api_keys(generate_random_key(32));
			}
		});

		let curl_users = document.getElementsByClassName("curl-users");
		for (let i = 0; i < curl_users.length; i++) {
			curl_users[i].textContent = get_curl_url("./users");
		}

		let curl_user_bob = document.getElementsByClassName("curl-user-bob");
		for (let i = 0; i < curl_user_bob.length; i++) {
			curl_user_bob[i].textContent = get_curl_url("./users/a6d10077-362b-4cb8-843d-0a38b7c0b07d");
		}
		//document.getElementById("curl-user-bob").innerText = get_curl_url("./users/a6d10077-362b-4cb8-843d-0a38b7c0b07d");

		update_example_api_keys(generate_random_key(32));
	</script>
</body>
