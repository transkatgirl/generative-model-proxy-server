<!DOCTYPE html>

<head>
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width,initial-scale=1">
	<title>Program documentation</title>
</head>

<!--
	Yes, this HTML is hand-written.
	Any commented-out behavior (such as configuration options for features) should be considered undocumented, as most of it is either broken and/or *very* incomplete.

	Use undocumented features at your own risk. They may lead to dangerous and unexpected behavior, such as database corruption, program crashes, leakage of sensitive information, or other damaging results. Please, don't use them in production if you value your job.

	Undocumented features that don't require administrative permissions to enable will not lead to dangerous behavior. However, they may still lead to unexpected results, which may contradict their incomplete documentation.
-->

<body>
	<h1>Generative Model Proxy Server</h1>
	<nav id="table-of-contents">
		<h2>Table of Contents</h2>
		<ol>
			<li><a href="#overview">Request Routing Overview</a></li>
			<li><a href="#objects">Internal Objects</a>
				<ol>
					<li><a href="#user">User</a></li>
					<li><a href="#role">Role</a></li>
					<li><a href="#model">Model</a></li>
					<li><a href="#quota">Quota</a></li>
					<li><a href="#datatypes">Datatypes</a>
						<ol>
							<li><a href="#positive-whole-number">PositiveWholeNumber</a></li>
							<li><a href="#uuid">Uuid</a></li>
						</ol>
					</li>
				</ol>
			</li>
			<li><a href="#request-handling">Request Handling Flow</a></li>
			<li><a href="#command-line-flags">Additional Configuration</a></li>
		</ol>
	</nav>
	<section id="overview">
		<h2>Request Routing Overview</h2>
		<p>Requests are routed to the following endpoints, in order of priority:</p>
		<ul>
			<li>/admin/ - <code>admin_router</code> endpoints
				<ul>
					<li>/{<a href="./users">users</a>|<a href="./roles">roles</a>|<a href="./models">models</a>|<a
							href="./quotas">quotas</a>}
						<ul>
							<li>GET / - Retrieves all objects of a specific type.</li>
							<li>POST / - Adds an object.
								<ul>
									<li>JSON body required.</li>
									<li>Cannot be used to create an object with a specific UUID.</li>
								</ul>
							</li>
							<li>PUT / - Adds or replaces an object with a specific UUID.
								<ul>
									<li>JSON body required.</li>
									<li>Object must contain a valid UUID.</li>
								</ul>
							</li>
							<li>GET /:uuid - Retrieves an object with a specific UUID.</li>
							<li>PUT /:uuid - Adds or replaces an object with a specific UUID.
								<ul>
									<li>JSON body required.</li>
									<li>Cannot be used to change the object's UUID.</li>
								</ul>
							</li>
							<!-- Need to add PATCH /:uuid -->
							<li>DELETE /:uuid - Deletes an object with a specific UUID.</li>
						</ul>
					</li>
					<li>GET <a href="./help">/help</a>
						<ul>
							<li>If the database has at least one user, the embedded <code>manual.html</code> page (this
								page) will be returned.</li>
							<li>If the database does not contain any users, the embedded
								<code>setup-instructions.html</code> page will be returned.
							</li>
						</ul>
					</li>
				</ul>
			</li>
			<li>/ - <code>model_request</code> endpoints (see <a href="#model">Model</a> object for available
				endpoints)
				<ul>
					<li>GET {endpoint}</li>
					<li>POST {endpoint} - JSON body<!-- or HTML Form data--> required</li>
				</ul>
			</li>
		</ul>
	</section>
	<section id="objects">
		<h2>Internal Objects</h2>
		<p>Object fields are mandatory unless otherwise specified.</p>
		<p>The following types of objects can be modified using the /admin/ API:</p>
		<ul>
			<li id="user">User
				<ul>
					<li>(optional) label: String
						<ul>
							<li>A human-readable label for the object. Multiple objects may have the same label.</li>
						</ul>
					</li>
					<li>(optional*) uuid: Uuid
						<ul>
							<li>Used as a reference to the object in logs, API calls, and from other objects (if
								applicable).</li>
							<li>A cryptographically hashed copy of the user's Uuid may be forwarded to model backends.
							</li>
						</ul>
					</li>
					<li>(optional) admin: Boolean
						<ul>
							<li>Allows giving administrative access to the user. This allows
								<strong>unrestricted
									access</strong> to the /admin/ API, but does not otherwise change how requests are
								handled.
							</li>
						</ul>
					</li>
					<li>(optional) api_keys: []String
						<ul>
							<li>A list of API keys that the user can authenticate with.</li>
							<li>The /admin/ API will not allow multiple users to have the same API key.</li>
						</ul>
					</li>
					<li>(optional) roles: []Uuid
						<ul>
							<li>A list of roles that the user should inherit models, quotas, and administrative status
								(if
								applicable) from.
							</li>
						</ul>
					</li>
					<li>(optional) models: []Uuid
						<ul>
							<li>A list of models that the user should be able to access.</li>
						</ul>
					</li>
					<li>(optional) quotas: []Uuid
						<ul>
							<li>A list of rate limiters that the user should be subject to.</li>
						</ul>
					</li>
				</ul>
			</li>
			<li id="role">Role
				<ul>
					<li>(optional) label: String
						<ul>
							<li>A human-readable label for the object. Multiple objects may have the same label.</li>
						</ul>
					</li>
					<li>(optional*) uuid: Uuid
						<ul>
							<li>Used as a reference to the object in logs, API calls, and from other objects (if
								applicable).</li>
						</ul>
					</li>
					<li>(optional) admin: Boolean
						<ul>
							<li>Allows giving administrative access to all users with this role. This allows
								<strong>unrestricted
									access</strong> to the /admin/ API, but does not otherwise change how requests are
								handled.
							</li>
						</ul>
					</li>
					<li>(optional) models: []Uuid
						<ul>
							<li>A list of models that all users with this role should be able to access.</li>
						</ul>
					</li>
					<li>(optional) quotas: []Uuid
						<ul>
							<li>A list of rate limiters that all users with this role should be subject to.</li>
						</ul>
					</li>
				</ul>
			</li>
			<li id="model">Model
				<ul>
					<li>(optional) label: String
						<ul>
							<li>A human-readable label for the object. Multiple objects may have the same label.</li>
						</ul>
					</li>
					<li>(optional*) uuid: Uuid
						<ul>
							<li>Used as a reference to the object in logs, API calls, and from other objects (if
								applicable).</li>
						</ul>
					</li>
					<li>(optional) name: String
						<ul>
							<li>Used to refer to the model in API calls.</li>
							<li>Model names should be carefully managed by the administrator. Having the same name +
								ModelType refer to multiple models that a user/role can access will lead to inconsistent
								behavior.</li>
						</ul>
					</li>
					<li>api: Object or String
						<ul>
							<li>(Key) String
								<ul>
									<li>The backend type used to handle requests to this model, represented as a String.
									</li>
								</ul>
							</li>
							<li>(Value) Object
								<ul>
									<li>An object containing backend-specific configuration options.</li>
									<li>If a backend has no configuration options, model.api should be represented
										by a String instead.</li>
								</ul>
							</li>
							<li>The following backends are currently supported:
								<ul>
									<li>OpenAI
										<ul>
											<li>model_string: String</li>
											<li>(optional**) model_context_len: PositiveWholeNumber</li>
											<li>openai_api_base: String</li>
											<li>openai_api_key: String</li>
											<li>(optional) openai_organization: String</li>
										</ul>
									</li>
									<li>Loopback
										<ul>
											<li>This backend has no configuration options.</li>
										</ul>
									</li>
								</ul>
							</li>
							<li>Additional backends may be added in future releases.</li>
						</ul>
					</li>
					<li>(optional) types: []String
						<ul>
							<li>A list of endpoint types that this model should respond to requests from.</li>
							<li>The following types are currently supported:
								<ul>
									<li>TextChat
										<ul>
											<li>/v1/chat/completions (OpenAI)</li>
										</ul>
									</li>
									<li>TextCompletion
										<ul>
											<li>/v1/completions (OpenAI)</li>
										</ul>
									</li>
									<li>TextEdit
										<ul>
											<li>/v1/edits (OpenAI)</li>
										</ul>
									</li>
									<li>TextEmbedding
										<ul>
											<li>/v1/embeddings (OpenAI)</li>
										</ul>
									</li>
									<li>TextModeration
										<ul>
											<li>/v1/moderations (OpenAI)</li>
										</ul>
									</li>
									<!--
										These are all untested and incomplete. They may or may not work.

									<li>ImageGeneration
										<ul>
											<li>/v1/images/generations (OpenAI)</li>
										</ul>
									</li>
									<li>ImageEdit
										<ul>
											<li>/v1/images/edits (OpenAI)</li>
										</ul>
									</li>
									<li>ImageVariation
										<ul>
											<li>/v1/images/variations (OpenAI)</li>
										</ul>
									</li>
									<li>AudioTTS
										<ul>
											<li>/v1/audio/speech (OpenAI)</li>
										</ul>
									</li>
									<li>AudioTranscription
										<ul>
											<li>/v1/audio/transcriptions (OpenAI)</li>
										</ul>
									</li>
									<li>AudioTranslation
										<ul>
											<li>/v1/audio/translations (OpenAI)</li>
										</ul>
									</li> -->
								</ul>
							</li>
							<li>Additional types may be added in future releases.</li>
						</ul>
					</li>
					<li>(optional) quotas: []Uuid
						<ul>
							<li>A list of rate limiters that all requests to this model should be subject to.</li>
						</ul>
					</li>
				</ul>
			</li>
			<li id="quota">Quota
				<ul>
					<li>(optional) label: String
						<ul>
							<li>A human-readable label for the object. Multiple objects may have the same label.</li>
						</ul>
					</li>
					<li>(optional*) uuid: Uuid
						<ul>
							<li>Used as a reference to the object in logs, API calls, and from other objects (if
								applicable).</li>
						</ul>
					</li>
					<li>(optional) limits: []Object
						<ul>
							<li>A list of rate limits that this rate limiter contains.</li>
							<li>count: PositiveWholeNumber
								<ul>
									<li>The maximum number of items per period.</li>
								</ul>
							</li>
							<li>type: String
								<ul>
									<li>The type of item that this limiter should limit.</li>
									<li>The following item types are supported:
										<ul>
											<li>Request</li>
											<li>Token</li>
										</ul>
									</li>
								</ul>
							</li>
							<li>period: PositiveWholeNumber
								<ul>
									<li>The period of time that this limit covers (ex. per-hour, per-minute, etc), in
										seconds.
									</li>
								</ul>
							</li>
							<li>(optional) state: Object
								<ul>
									<li>An object storing the state of a Limit.</li>
									<li>If not specified when updating an existing Limit (such as when updating a
										Quota), the
										state of
										the
										Limit will be reset.
										<ul>
											<li>This behavior may change in a future release.</li>
										</ul>
									</li>
									<li>This object's format may change between releases, and should not be relied upon.
									</li>
								</ul>
							</li>
						</ul>
					</li>
				</ul>
			</li>
			<li>* - UUIDs are mandatory when creating an object using the PUT method.</li>
			<li>** - If the model context length is not specified, it will default to a value of 1. This may result in
				unintended consequences when used with text-based models.</li>
		</ul>
		<section id="datatypes">
			<h3>Datatype JSON Representations</h3>
			<p>The following datatypes have non-trivial JSON representations:</p>
			<ul>
				<li id="positive-whole-number">PositiveWholeNumber (number)
					<ul>
						<li>A whole number greater than or equal to zero.</li>
						<li>Cannot be greater than (2^64)-1.</li>
					</ul>
				</li>
				<li id="uuid">Uuid (String)
					<ul>
						<li>A unique RFC4122-compliant UUID, represented in hyphenated form as a lowercase String.
						</li>
						<li>An example of a Uuid is <code>"67e55044-10b1-426f-9247-bb680e5fe0c8"</code>.</li>
						<li>A Uuid of all zeros is referred to as the null Uuid. Objects with a null Uuid cannot be
							created,
							retrieved, modified, or deleted via the /admin/ API.
						</li>
					</ul>
				</li>
			</ul>
		</section>
	</section>
	<section id="request-handling">
		<h2>Request Handling Flow</h2>
		<p>A rough overview of the request handling flow is below:</p>
		<ol>
			<li>HTTP authentication is attempted. If successful, the User object, along with all Roles that the User
				has, are retrieved from the database.</li>
			<li>If the request is to the /admin/ API, the authenticated User (along with all Roles said User has) will
				be checked for administrative permissions.
				<ol>
					<li>If the user has administrative permissions, then the request
						will be passed to the <code>admin_router</code>, which will send the request to the correct
						request
						handler.</li>
				</ol>
			</li>
			<li>If the request is not to a /admin/ endpoint, it is assumed it is a Model request.
				<ol>
					<li>The request handler
						attempts to parse the HTTP request's body into a <code>ModelRequest</code> object.</li>
					<li>If parsing is successful, all Models that the User & User's Roles can access will be retrieved
						from the
						database. Then, the list of Models will be searched for one which matches the request
						parameters.</li>
					<li>If a matching Model is found, all Quotas that the request will be subjected to (those of the
						User, the
						User's Roles, and the Model) will be retrieved from the database. A list of Tags (all object
						UUIDs
						associated with the request, along with a unique UUID specific to the request itself) will be
						constructed for logging purposes.</li>
					<li>The request will be run against the Quotas, using the maximum possible number of tokens (the
						minimum of
						the
						request's <code>max_tokens</code> and the Model's token maximum, multiplied by the number of
						queries in the request) for rate limiting purposes.
					</li>
					<li>The request will then be sent to the Model's backend, which will generate a
						<code>ModelResponse</code>
						object.
						<ul>
							<li>The request may be modified before being sent to the backend, in order to allow for
								translation between model APIs.</li>
							<li>The proxy does not currently support streamed responses.</li>
						</ul>
					</li>
					<li>All of the request's Quotas will be readjusted based on the actual number of tokens used. The
						<code>ModelResponse</code> will then be converted into an HTTP response.
						<ul>
							<li>The response may contain additional fields not recognized by the API the user is
								using. This is because the response uses a "hybrid" format, which contains the fields
								expected by multiple different model calling APIs.
							</li>
						</ul>
					</li>
				</ol>
			</li>
		</ol>
	</section>
	<section id="command-line-flags">
		<h2>Additional Configuration</h2>
		<p>In addition to the /admin/ API, the behavior of the proxy can be customized through command-line flags.</p>
		<p>The list of available command-line flags is subject to change between releases. Run the proxy binary with the
			<code>--help</code> flag for documentation regarding available command-line flags.
		</p>
	</section>
	<footer>
		<hr />
		<p><a href="https://github.com/transkatgirl/generative-model-proxy-server">Generative Model Proxy Server</a> by
			<a href="https://github.com/transkatgirl">transkatgirl</a>
		</p>
	</footer>
</body>
